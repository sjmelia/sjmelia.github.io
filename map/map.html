<html>
	<head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Permanent+Marker' rel='stylesheet' type='text/css'>
		<style>
            #canvas { border: 0px; } /*width:100%; height:100%; }*/
            #underlying { display: none; }
            html, body { height : 100%; margin: 0; font-family:Permanent Marker; }
            #header { height: 87px; }
            #wrapper { display: flex; min-height: 100%; flex-direction: column; }
            #main { flex: 1; }
            #footer { height: 100px;}
            #header p { float: right; }
		</style>	
	</head>
    <body>
        <div id="wrapper">
            <div id="header">
                <p>Map courtesy of <a href="http://en.wikipedia.org/wiki/Continent#/media/File:Continents_vide_couleurs.png">Wikipedia</a></p>
                <h1>Continent Map!</h1>
            </div>
            <div id="main">
                    <canvas id="canvas" width="300" height="300"></canvas>
            </div>
            <div id="footer">
                Click on the map to select a region!
            </div>
        </div>
		<img id="underlying" src="Continents_vide_couleurs.png"/>
	</body>

	<script type="text/javascript">

		// shim layer with setTimeout fallback
		window.requestAnimFrame = (function(){
		  return  window.requestAnimationFrame       ||
		          window.webkitRequestAnimationFrame ||
		          window.mozRequestAnimationFrame    ||
		          function( callback ){
		            window.setTimeout(callback, 1000 / 60);
		          };
		})();

		var fps = 30;

		var map = function(game) {
			this.game = game;
			this.image = $('#underlying');
			this.x = 0; 
            this.y = 0;

            this.regions = {};
            this.regions[16777470] = "Sea or border";
            this.regions[13369599] = "North America";
            this.regions[8388863] = "South America";
            this.regions[448] = "Europe";
            this.regions[13971453] = "Africa";
            this.regions[4063986] = "Asia";
            this.regions[4259839] = "Antarctica";
            this.regions[4227519] = "Oceania";

            this.init = function() {
                cvs = document.createElement('canvas');
                cvs.width = this.image[0].width;
                cvs.height = this.image[0].height;
                imgContext = cvs.getContext("2d");
                imgContext.drawImage(this.image[0], 0, 0, cvs.width, cvs.height);
                this.imageData = imgContext.getImageData(0,0, cvs.width, cvs.height);
            };
            this.init();
            this.getRegion = (function(x, y) {
                var index = y * this.imageData.width + x;
                var i = index * 4;
                var d = this.imageData.data;
                var colour = (d[i] << 32) + (d[i+1] << 16) + (d[i+2] << 8) + d[i+3];
                if (!(colour in this.regions))
                {
                    return colour;
                }
                return this.regions[colour];

            }).bind(this);

			this.render = function(context) {
				context.drawImage(this.image[0], this.x, this.y);
			};
			this.logic = function() {
			};
		};

        var game = function() {
            this.map = new map(this);
            this.clicks = [];
            this.container = $('#main');
            this.render = function(context) {
                context.canvas.width = window.innerWidth;
                context.canvas.height = window.innerHeight-200;


                context.clearRect(0, 0, context.canvas.width, context.canvas.height);
			    this.map.render(context);
                /*context.font = "20px Permanent Marker";
                context.fillStyle = "black";
                context.fillText("NUTS!",30,30);*/
			};
			this.logic = function() {
                this.map.logic();
                while (i = this.clicks.pop())
                {
                    var c = this.map.getRegion(i[0], i[1]);
                    $('#footer').text("You clicked " + c);
                }
            };
            this.queueClick = (function(pt) {
                this.clicks.push(pt);
            }).bind(this);
		};

		var canvas = $('#canvas')[0];
        var getCursorPosition = function(e) {			
			var x;
    			var y;
    			if (e.pageX != undefined && e.pageY != undefined) {
				x = e.pageX;
				y = e.pageY;
    			}
    			else {
				x = e.clientX + document.body.scrollLeft +
            			document.documentElement.scrollLeft;
				y = e.clientY + document.body.scrollTop +
            			document.documentElement.scrollTop;
    			}

			x -= canvas.offsetLeft;
			y -= canvas.offsetTop;
			return [x,y];
		}

        var context = canvas.getContext('2d');

        $('#underlying')[0].onload = function() {
        var gameInstance = new game();

        canvas.addEventListener("click", function(e) {
                var pt = getCursorPosition(e);
                gameInstance.queueClick(pt);
                });

        var animLoop = (function (){
			setTimeout(function() { requestAnimFrame(animLoop); }, 1000 / fps);
			gameInstance.logic();
			gameInstance.render(context);
		});
        animLoop();

        };
	</script>
</html>
